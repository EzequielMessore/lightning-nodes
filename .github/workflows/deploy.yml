name: Build and Deploy to Play Store
on:
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag'
        required: true
  release:
    types: [ published ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: '17'

      - name: Get tag name
        run: echo "TAG_NAME=${{ github.event.release.tag_name }}" >> $GITHUB_ENV

      - name: Extract existing version code
        run: |
          RELEASE_TAG=${{ env.TAG_NAME }}
          LAST_VERSION=$(grep "versionCode" gradle/libs.versions.toml | awk -F '"' '{print $2}')
          NEW_VERSION=$((LAST_VERSION + 1))

          echo "VERSION_NAME=$RELEASE_TAG" >> $GITHUB_ENV
          echo "VERSION_CODE=$NEW_VERSION" >> $GITHUB_ENV
          echo $GITHUB_ENV

      - name: Get release notes
        id: release_notes
        env:
          RELEASE_BODY: ${{ github.event.release.body }}
        run: |
          # export multiline notes to GITHUB_OUTPUT
          echo "notes<<EOF" >> "$GITHUB_OUTPUT"
          printf "%s\n" "$RELEASE_BODY" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"
          echo "$GITHUB_OUTPUT"
